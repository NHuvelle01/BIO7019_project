file.path(Graph_Niefern_file, "NDVI_per_subplotLU.png")
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
library(terra)
library(dplyr)
library(tidyr)
library(ggplot2)
library(here)
LandUse_file <- here("Niefern_NDVI/LandUse") #Input
NDVI_rasters_file <- here("Niefern_NDVI/NDVI_rasters") #Input
Graph_Niefern_file <- here("Graphs/Niefern_NDVI") #Output
NDVI_csv_file <- here("run_scenarios/QualityFlo_treatment")#Output
LandUse_file <- here("Niefern_NDVI/LandUse") #Input
NDVI_rasters_file <- here("Niefern_NDVI/NDVI_rasters") #Input
Graph_Niefern_file <- here("Graphs/Niefern_NDVI") #Output
NDVI_csv_file <- here("run_scenarios/QualityFlo_treatment")#Output
# List of raster files
ras_files <- list.files(NDVI_rasters_file, pattern = "\\.tif$", full.names = TRUE)
# Stack them into a SpatRaster multibands
ndvi_rast <- rast(ras_files)
# Set names to source file names
layer_names <- tools::file_path_sans_ext(basename(ras_files))
names(ndvi_rast) <- layer_names
# Read shapefile
plots <- vect(paste(LandUse_file,"/Niefern_LandUse.shp", sep=""))
# Check if crs compatible
crs(ndvi_rast)
crs(plots)
ndvi_per_plot <- terra::extract(
ndvi_rast,
plots,
fun   = mean,
na.rm = TRUE,
bind  = TRUE
)
ndvi_per_plot <- as.data.frame(ndvi_per_plot)
ndvi_per_plot
#Create a raster of ones
r1 <- ndvi_rast[[1]] * 0 + 1
#Get the number of pixels per polygon (.shp)
pix_count <- terra::extract(r1, plots, fun = sum, na.rm = TRUE, bind = TRUE)
pix_count$Niefern_2015_NDVI_2015.04.08
#Set a threshold of 80% of pixels needing to be present to consider the NDVI value
pix_thresh <- pix_count$Niefern_2015_NDVI_2015.04.08 * 0.8
#Extract the pixel count for each raster, and each plot
valid <- !is.na(ndvi_rast)
valid_num <- classify(valid, rbind(c(0, NA), c(1, 1)))
ndvi_counts <- terra::extract(
valid_num,
plots,
fun   = sum,   # somme des 1 = nombre de pixels valides
na.rm = TRUE,
bind  = TRUE
)
#NDVI layers name
layer_names <- names(ndvi_rast)
#Loop over ndvi_per_pot to set to NA where pixels_count < pixels_max
for (nm in layer_names) {
# vector with all ndvi counts
count_vec <- ndvi_counts[[nm]]
# rows where count < thres and non NAl
idx <- !is.na(count_vec) & count_vec < pix_thresh
if (nm %in% names(ndvi_per_plot)) {
ndvi_per_plot[idx, nm] <- NA
}
}
ndvi_per_plot
ndvi_long <- ndvi_per_plot  %>%
pivot_longer(
cols = starts_with("Niefern_2015_NDVI_"),
names_to = "date",
values_to = "ndvi_mean",
names_pattern = "Niefern_2015_NDVI_(.*)$"
) %>%
mutate(
date = as.Date(date, format = "%Y.%m.%d"),
LandUse = as.factor(LandUse),
LandUse = recode(LandUse,  "1" = "Culture",
"2" = "Bois",
"3" = "Urbain",
"5" = "Semi-naturelle mixte")
)
ndvi_long
ndvi_per_subplotLU <- ggplot(ndvi_long, aes(x = date, y = ndvi_mean, group = id)) +
geom_line(color = "darkgreen", alpha = 0.4) +
geom_point(color = "darkgreen") +
facet_wrap(~ LandUse) +
labs(
title = "NDVI moyen par parcelle et par occupation du sol pour l'annÃ©e 2015",
x = "Date",
y = "NDVI moyen [-]"
) +
scale_x_date(date_labels = "%d-%m")+
theme_minimal()
ndvi_per_subplotLU
ggsave(filename = paste(Graph_Niefern_file,
"/NDVI_per_subplotLU.png", sep=""),
plot = ndvi_per_subplotLU,
height = 5, width = 12)
