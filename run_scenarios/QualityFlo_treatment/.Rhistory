library(tidyverse)
library(readxl)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(purrr)
library(here)
QualityFlo_file <- here("run_scenarios/QualityFlo_treatment")
Graph_file <- here("Graphs/NDVI_to_QualityFlo") #output
setwd(QualityFlo_file)
ndvi <- read.csv("NDVI_mean_per_LUday.csv")
str(ndvi)
#Date format
ndvi$date <- as.Date(ndvi$date)
#Factorisation of LandUse
ndvi$LandUse <- as.factor(ndvi$LandUse)
bbch <- read.csv("OSR_BBCH_S15_01802_Nie2015.csv", skip=3)
bbch$Date <- as.Date(bbch$Date)
head(bbch)
ndvi_culture <- ndvi %>% filter(LandUse == "Culture")
ggplot(ndvi_culture,
aes(x = date,
y = ndvi_mean_interp)) +
geom_line(alpha = 0.7) +
geom_line(
data = bbch,
aes(x = Date, y = X..of.flowers.open/100, color = "Fleurs ouvertes"),
inherit.aes = FALSE,
linetype = "dashed"
) +
labs(
title = "Évolution du NDVI moyen et % de fleurs ouvertes",
x = "Date",
y = "NDVI moyen / % fleurs ouvertes",
color = "Légende"
) +
theme_minimal()
ndvi_culture_zoom <- ndvi_culture  %>%
filter(date >= as.Date("2015-04-01"),
date <= as.Date("2015-06-30"))
ggplot(ndvi_culture_zoom,
aes(x = date,
y = ndvi_mean_interp)) +
geom_line(alpha = 0.7) +
geom_line(
data = bbch,
aes(x = Date, y = X..of.flowers.open/100, color = "Fleurs ouvertes"),
inherit.aes = FALSE,
linetype = "dashed"
) +
labs(
title = "Évolution du NDVI moyen et % de fleurs ouvertes",
x = "Date",
y = "NDVI moyen / % de fleurs ouvertes",
color = "Légende"
) +
theme_minimal()
NDVI_min <- min(ndvi_culture$ndvi_mean_interp)
NDVI_max <- max(ndvi_culture$ndvi_mean_interp)
ampl <- NDVI_max - NDVI_min
lambda <- 0.89
NDVI_thres <- NDVI_min + lambda*ampl
dates <- seq(from = ndvi_culture$date[1],
to = ndvi_culture$date[nrow(ndvi_culture)],
by = "day")
NDVI_thres_vec <- rep(NDVI_thres,
length(dates))
NDVI_thres_df <- data.frame(date = dates,
NDVI_thres = NDVI_thres_vec)
plot_ndvi_crop_obs_mod <- ggplot(ndvi_culture,
aes(x = date,
y = ndvi_mean_interp,
colour = "NDVI")) +
geom_line(alpha = 0.7) +
geom_line(
data = bbch,
aes(x = Date, y = X..of.flowers.open/100,
colour = "Fleurs ouvertes"),
inherit.aes = FALSE,
linetype = "dashed"
) +
geom_line(
data = NDVI_thres_df,
aes(x = date, y = NDVI_thres,
colour = "NDVI seuil"),
inherit.aes = FALSE,
linetype = "dashed"
) +
scale_color_manual(
name = "Légende",
values = c(
"NDVI" = "black",
"Fleurs ouvertes" = "#d95f02",
"NDVI seuil" = "red"
)
) +
labs(
title = "",
x = "Date",
y = "NDVI / % de fleurs ouvertes"
) +
theme_minimal()
plot_ndvi_crop_obs_mod
id_above <- which(ndvi_culture$ndvi_mean_interp >= NDVI_thres)
#SOS = Start Of Season = 1rst date where NDVI >= NDVI_threshold
SOS_date <- ndvi_culture$date[id_above[1]]
#EOS = End of Season = last date where NDVI >= NDVI_threshold
EOS_date <- ndvi_culture$date[id_above[length(id_above)]]
#Peak = Date where NDVI is max
peak_id  <- which.max(ndvi_culture$ndvi_mean_interp)
Peak_date <- ndvi_culture$date[peak_id]
Peak_val  <- ndvi_culture$ndvi_mean_interp[peak_id]
quality_crop <- ifelse(
ndvi_culture$date >= SOS_date & ndvi_culture$date <= EOS_date,
# Calculate Quality_nat only btwn SOS and EOS, else 0
(ndvi_culture$ndvi_mean_interp - NDVI_min) / (NDVI_max - NDVI_min),
0
)
quality_crop_df <- data.frame(date = ndvi_culture$date,
quality_crop = quality_crop)
plot_crop <- ggplot(ndvi_culture,
aes(x = date,
y = ndvi_mean_interp,
colour = "NDVI")) +
geom_line(alpha = 0.7) +
geom_line(
data = bbch,
aes(x = Date, y = Proportional.resource.availability, color = "Quality_crop (BBCH)"),
inherit.aes = FALSE,
linetype = "twodash"
) +
geom_line(
data = quality_crop_df,
aes(x = date, y = quality_crop, color = "Quality_crop (NDVI)"),
inherit.aes = FALSE,
linetype = "twodash"
) +
geom_line(
data = NDVI_thres_df,
aes(x = date, y = NDVI_thres,
colour = "NDVI seuil"),
inherit.aes = FALSE,
linetype = "dashed"
) +
scale_color_manual(
name = "Légende",
values = c(
"NDVI" = "black",
"NDVI seuil" = "brown3",
"Quality_crop (BBCH)" = "cyan4",
"Quality_crop (NDVI)" = "darkolivegreen"
)
) +
scale_x_date(date_labels = "%d-%m") +
labs(
title = "",
x = "Date",
y = "NDVI [-] / Quality_crop[-]",
color = "Légende"
) +
theme_minimal() +
theme(legend.position = "bottom")
plot_crop
ggsave(paste(Graph_file, "/ndvi_quality_crop.png", sep=""),
plot_crop, width= 6 , height = 2.5)
#Get the slope value from 04-08 to 04-24
ndvi_nat <- ndvi %>% filter(LandUse == "Bois")
ndvi_mixt <- ndvi %>% filter(LandUse == "Semi-naturelle mixte")
ggplot(ndvi_nat,
aes(x = date,
y = ndvi_mean_interp,
colour = "Milieu boisé")) +
geom_line(alpha = 0.7) +
geom_line(
data = ndvi_mixt,
aes(x = date, y = ndvi_mean_interp, color = "Milieu naturel mixte"),
inherit.aes = FALSE,
linetype = "dashed"
) +
labs(
title = "Évolution du NDVI moyen des milieux naturels (boisés et mixtes)",
x = "Date",
y = "NDVI moyen",
color = "Légende"
) +
scale_color_manual(
name = "Légende",
values = c(
"Milieu boisé" = "black",
"Milieu naturel mixte" = "#d95f02"
)) +
theme_minimal()
compute_quality_flo <- function(ndvi_data,
lambda = 0.89,
ndvi_col = "ndvi_mean_interp",
date_col = "date",
min_length = 3) {
# Extract ndvi and date values
ndvi_vals <- ndvi_data[[ndvi_col]]
dates     <- ndvi_data[[date_col]]
# Get NDVI min, max, amplitude
NDVI_min <- min(ndvi_vals, na.rm = TRUE)
NDVI_max <- max(ndvi_vals, na.rm = TRUE)
ampl     <- NDVI_max - NDVI_min
if (ampl == 0) {
stop("Amplitude NDVI = 0 (NDVI constant).")
}
# Function if lambda is a single value
one_lambda <- function(lam) {
NDVI_thres <- NDVI_min + lam * ampl
# mask TRUE/FALSE where NDVI >= NDVI threshold (ignores NA)
above <- ndvi_vals >= NDVI_thres & !is.na(ndvi_vals)
# RLE (Run Length Encoding) to find the MULTIPLE consecutive sequences where NDVI > NDVI_thres
r <- rle(above)
ends   <- cumsum(r$lengths)
starts <- ends - r$lengths + 1
# Indices where sequences : above == TRUE
idx_true <- which(r$values)
season_id <- rep(NA_integer_, length(ndvi_vals))
SOS_vec   <- c()
EOS_vec   <- c()
season_counter <- 0L
for (k in idx_true) {
s <- starts[k]
e <- ends[k]
# Filter sequences too short
if (r$lengths[k] < min_length) next
season_counter <- season_counter + 1L
season_id[s:e] <- season_counter
SOS_vec <- c(SOS_vec, dates[s])
EOS_vec <- c(EOS_vec, dates[e])
}
# Peak date
peak_id   <- which.max(ndvi_vals)
Peak_date <- dates[peak_id]
Peak_val  <- ndvi_vals[peak_id]
# quality_flo only inside the sequences where NDVI > NDVI_thres
quality_flo <- ifelse(
!is.na(season_id),
(ndvi_vals - NDVI_min) / (NDVI_max - NDVI_min),
0
)
# Returning Data.frame for this lambda value
quality_flo_df <- data.frame(
date         = dates,
lambda       = lam,
quality_flo = quality_flo
)
# Returning phenological data
list(
lambda    = lam,
NDVI_min  = NDVI_min,
NDVI_max  = NDVI_max,
ampl      = ampl,
NDVI_thres = NDVI_thres,
SOS_date  = SOS_date,
EOS_date  = EOS_date,
Peak_date = Peak_date,
Peak_val  = Peak_val,
quality_flo_df = quality_flo_df
)
}
# If a single lambda -> a simple list
if (length(lambda) == 1) {
one_lambda(lambda)
} else {
# If multiple lambdas -> a named list by lambda
res <- lapply(lambda, one_lambda)
names(res) <- paste0("lambda_", lambda)
res
}
}
NDVI_thres_nat_vec <- rep(NDVI_thres_nat,
length(quality_nat$date))
quality_nat_df <- compute_quality_flo(ndvi_nat,
lambda = 0.89)
str(quality_nat_df)
quality_nat <- quality_nat_df$quality_flo_df
NDVI_thres_nat <- quality_nat_df$NDVI_thres
NDVI_thres_nat_vec <- rep(NDVI_thres_nat,
length(quality_nat$date))
NDVI_thres_nat_df <- data.frame(date = quality_nat$date,
NDVI_thres_nat = NDVI_thres_nat_vec)
plot_nat <- ggplot(ndvi_nat,
aes(x = date,
y = ndvi_mean_interp,
colour = "NDVI")) +
geom_line(alpha = 0.7) +
geom_line(
data = quality_nat,
aes(x = date, y = quality_flo, color = "Quality_nat (NDVI)"),
inherit.aes = FALSE,
linetype = "twodash"
) +
geom_line(
data = NDVI_thres_nat_df,
aes(x = date, y = NDVI_thres_nat, color = "NDVI seuil"),
inherit.aes = FALSE,
linetype = "dashed"
) +
scale_color_manual(
name = "Légende",
values = c(
"NDVI" = "black",
"NDVI seuil" = "brown3",
"Quality_nat (NDVI)" = "darkolivegreen"
)
) +
scale_x_date(date_labels = "%d-%m") +
labs(
title = "",
x = "Date",
y = "NDVI [-] / Quality_nat[-]",
color = "Légende"
) +
theme_minimal() +
theme(legend.position = "bottom")
plot_nat
ggsave(paste(Graph_file, "/ndvi_quality_nat.png", sep=""),
plot_nat, width= 6 , height = 2.5)
quality_flo <- quality_crop_df %>%
left_join(quality_nat, by = "date")
colnames(quality_flo)[4] <- "quality_nat"
quality_flo
prop_forag_crop <- c()
alpha <- 0.73
for (i in 1:nrow(quality_flo)){
if (quality_flo$quality_crop[i] + quality_flo$quality_nat[i] == 0){
prop_forag_crop[i] <- 0
} else {
prop_forag_crop[i] <- alpha * quality_flo$quality_crop[i] /
(quality_flo$quality_crop[i] + quality_flo$quality_nat[i])
}
}
prop_forag_crop
quality_flo$prop_forag_crop <- prop_forag_crop
plot_prop_forag_crop <- ggplot(quality_flo,
aes(x = date))+
geom_line(aes(y = quality_crop, colour = "Quality_crop"),
linetype = "twodash")+
geom_line(aes(y = quality_nat, colour = "Quality_nat"),
linetype = "twodash")+
geom_line(aes(y = prop_forag_crop, colour = "Prop_foraging_crop"))+
labs(
title = "",
x = "Date",
y = "Quality_crop/nat [-] / Prop_foraging_crop [-]",
color = "Légende"
) +
scale_x_date(date_labels = "%d-%m") +
scale_color_manual(
name = "Légende",
values = c(
"Prop_foraging_crop" = "brown3",
"Quality_crop" = "cyan4" ,
"Quality_nat" = "darkolivegreen"
)
) +
theme_minimal() +
theme(legend.position = "bottom",
axis.title = element_text(size = 7),
legend.title = element_text(size = 7),
legend.text = element_text(size = 7)
)
plot_prop_forag_crop
plot_prop_forag_crop
ggsave(paste(Graph_file, "/prop_forag_crop", sep=""),
plot_prop_forag_crop,
width= 6 , height = 2.5)
ggsave(paste(Graph_file, "/prop_forag_crop.png", sep=""),
plot_prop_forag_crop,
width= 6 , height = 2.5)
quality_flo
write.csv(quality_flo,
"QualityFlo_baseline.csv")
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
library(ggplot2)
weather_Ruddle <- read.csv("Weather_Ruddle_et_al_study_2015_Nie.csv", skip = 5)
head(weather_Ruddle)
colnames(weather_Ruddle) <- c("date", "DOY", "T_mean", "T_max", "T_min", "Precip", "RH")
weather_Ruddle$date <- as.Date(weather_Ruddle$date)
head(weather_Ruddle)
weather_data_file <- here("run_scenarios/QualityFlo_treatment/weather_data")
rm(list = ls())
library(ggplot2)
library(here)
weather_data_file <- here("run_scenarios/QualityFlo_treatment/weather_data")
wd_file <- here("run_scenarios/QualityFlo_treatment")
setwd(wd_file)
weather_data_file <- here("run_scenarios/QualityFlo_treatment/weather_sup_data")
weather_Ruddle <- read.csv("Weather_Ruddle_et_al_study_2015_Nie.csv", skip = 5)
head(weather_Ruddle)
colnames(weather_Ruddle) <- c("date", "DOY", "T_mean", "T_max", "T_min", "Precip", "RH")
weather_Ruddle$date <- as.Date(weather_Ruddle$date)
head(weather_Ruddle)
min.temp <- 18
max.precip <- 25.4
max.humid <- 80
# 3 subplots in 1 col
par(mfrow = c(3, 1), mar = c(4, 4, 2, 1))
## Graph with T_max + threshold min.temp
plot(weather_Ruddle$date, weather_Ruddle$T_max,
type = "l",
xlab = "Date",
ylab = "T_max (°C)",
main = "Température max quotidienne")
abline(h = min.temp, col = "red", lty = 2, lwd = 2)
legend("topright", legend = paste("Seuil :", min.temp, "°C"),
lty = 2, lwd = 2, col = "red", bty = "n")
# 3 subplots in 1 col
par(mfrow = c(3, 1), mar = c(4, 4, 2, 1))
## Graph with T_max + threshold min.temp
plot(weather_Ruddle$date, weather_Ruddle$T_max,
type = "l",
xlab = "Date",
ylab = "T_max (°C)",
main = "Température max quotidienne")
abline(h = min.temp, col = "red", lty = 2, lwd = 2)
legend("topright", legend = paste("Seuil :", min.temp, "°C"),
lty = 2, lwd = 2, col = "red", bty = "n")
##Graph with Precip + threshold max.precip
plot(weather_Ruddle$date, weather_Ruddle$Precip,
type = "h",
xlab = "Date",
ylab = "Précipitation (mm)",
main = "Précipitations quotidiennes")
abline(h = max.precip, col = "blue", lty = 2, lwd = 2)
legend("topright", legend = paste("Seuil :", max.precip, "mm"),
lty = 2, lwd = 2, col = "blue", bty = "n")
## Graph with RH + threshold max.humid
plot(weather_Ruddle$date, weather_Ruddle$RH,
type = "l",
xlab = "Date",
ylab = "Humidité relative (%)",
main = "Humidité relative quotidienne")
abline(h = max.humid, col = "darkgreen", lty = 2, lwd = 2)
legend("topright", legend = paste("Seuil :", max.humid, "%"),
lty = 2, lwd = 2, col = "darkgreen", bty = "n")
# Creation of the prop_forag_day dataframe with a date column
prop_forag_day <- data.frame(matrix(NA, nrow = 365, ncol = 2))
colnames(prop_forag_day) <- c("date", "Prop_foraging_day")
prop_forag_day$date <- seq(from = as.Date("2015-01-01"),
to = as.Date("2015-12-31"),
by = "day")
# Definition of time intervals where Prop_forag_day will be set to 0/1
set_interval <- function(df, start, end, value){
df$Prop_foraging_day[df$date >= as.Date(start) &
df$date <= as.Date(end)] <- value
return(df)
}
## Prop_foraging_day set to 1 from 2015-06-10 to 2015-10-01
prop_forag_day <- set_interval(prop_forag_day, "2015-06-10", "2015-10-01", 1)
##Prop_foraging_day set to 0 from 2015-10-02 to 2015-12-31 AND from 2015-01-01 to 2015-04-20
prop_forag_day <- set_interval(prop_forag_day, "2015-10-02", "2015-12-31", 0)
prop_forag_day <- set_interval(prop_forag_day, "2015-01-01", "2015-04-20", 0)
# Calculate prop_foraging_day based on meteorological data
## Join prop_forag_day and weather data by date
df <- merge(
prop_forag_day,
weather_Ruddle[, c("date", "T_max", "Precip", "RH")],
by = "date",
all.x = TRUE
)
# Create a vector which specifies which rows satisfy the meteo conditions
ok <- is.na(df$Prop_foraging_day) & #Only take into account the NA values in prop_foraging_day
df$T_max  > min.temp   &
df$Precip < max.precip &
df$RH     < max.humid
df$Prop_foraging_day[ok] <- 1 #If all conditons ok then prop_foraging_day = 1
df$Prop_foraging_day[is.na(df$Prop_foraging_day)] <- 0 #Otherwise, prop_foraging_day = 0
# Put the results back into the original df
prop_forag_day$Prop_foraging_day <- df$Prop_foraging_day
prop_forag_day
ggplot(prop_forag_day,
aes(x = date,
y = Prop_foraging_day)) +
geom_line(alpha = 0.7)
write.csv(prop_forag_day,
"PropForagDay_baseline.csv")
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
library(ggplot2)
library(dplyr)
library(tidyr)
rm(list = ls())
library(ggplot2)
library(dplyr)
library(tidyr)
wd <- here("run_scenarios/QualityFlo_treatment")
setwd(wd)
ress_flo <- read.csv("QualityFlo_baseline.csv")
ress_flo$X.1 <- NULL
ress_flo$date <- as.Date(ress_flo$date)
head(ress_flo)
prop_forag_day <- read.csv("PropForagDay_baseline.csv")
prop_forag_day$date <- as.Date(prop_forag_day$date)
prop_forag_day$X <- NULL
head(prop_forag_day)
ress_flo_out <- ress_flo %>%
left_join(prop_forag_day, by = "date")
head(ress_flo_out)
ress_flo_out$date <- NULL #Suppress date column
ress_flo_out$lambda <- NULL
ress_flo_out <- ress_flo_out[, c("X", "Prop_foraging_day",
"quality_crop", "quality_nat",
"prop_forag_crop")] #Reorganize column order
colnames(ress_flo_out) <- c("doy", "Prop_foraging_day",
"Quality_crop", "Quality_nat",
"Prop_foraging_crop")#Rename the columns
head(ress_flo_out)
